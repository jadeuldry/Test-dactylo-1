<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test de dactylographie</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #texte-reference { margin-bottom: 20px; font-style: italic; color: #555; white-space: pre-line; }
    input, textarea { width: 100%; font-size: 16px; margin-bottom: 10px; padding: 5px; }
    button { margin-top: 15px; padding: 10px 20px; font-size: 16px; }
    #resultat { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>

  <h1>Exercice de frappe</h1>

  <input type="text" id="nom" placeholder="Entrez votre nom">

  <p id="texte-reference">
Au jour et à l'heure précités, les hommes du feu ainsi que nos collègues de Police-secours / Police secours / Police Secours sont intervenus en zone foraine pour un incendie dans la halle industrielle de la scierie.
Une fois l'incendie maîtrisé / maitrisé, par le personnel du SPSL ainsi que celui du SDIS, soit vers vingt heures, plusieurs pompiers sont restés sur les lieux durant la nuit, pour surveiller le sinistre et éviter que le feu ne reprenne.
Le procureur de l'arrondissement de Lausanne a été avisé des faits. Il a été renseigné au fur et à mesure de nos investigations.
En compagnie de deux inspectrices de la Police cantonale vaudoise, nous nous sommes déplacés le jeudi quatre août, afin d'effectuer un constat technique. Lors de notre second passage, le chien incendie a fait des recherches approfondies sur le site. Celles-ci ont permis d'effectuer des prélèvements de résidus d'incendie.
Lors de nos investigations, nous avons procédé à plusieurs auditions. Aucune des personnes n'a vu ou croisé de personne suspecte / personnes suspectes, à proximité de la scierie, le jour en question. Nous résumons leurs déclarations comme suit :
Personne un
Personne deux
L'intéressé dispose d'un atelier en face de la scierie. Selon lui et la copie de la carte de timbrage de son amie, il a quitté son travail à 19h15 pour aller la chercher, à son travail. En sortant du bureau, il a vu des flammes qui se situaient derrière le local technique de la scierie. Depuis son emplacement, il ne voyait pas le foyer mais uniquement les flammes qui passaient au-dessus dudit local. Il ne s'est pas trop inquiété de la situation, pensant qu'un employé devait être à proximité. Selon lui, les flammes ne touchaient pas la paroi du bâtiment principal mais devaient être à une distance estimée à trois mètres. En rentrant à son domicile, soit environ trente minutes plus tard, il n'a rien constaté de spécial. Il n'a pas vu si les flammes étaient toujours actives.
  </p>

  <textarea id="zone-saisie" placeholder="Tape ici le texte..."></textarea><br>
  <button onclick="terminer()">Envoyer le résultat</button>

  <p id="resultat"></p>

  <script>
    const TEXTE_ATTENDU = document.getElementById("texte-reference").innerText.trim();
    let debut = Date.now();

    function calculerPenalitesAvancees(saisi, attendu) {
      let penalites = 0;
      const lignesSaisies = saisi.split("\n");
      const lignesAttendues = attendu.split("\n");
      let lignesRatees = 0;

      for (let i = 0; i < Math.max(lignesSaisies.length, lignesAttendues.length); i++) {
        const ligneSaisie = lignesSaisies[i] || "";
        const ligneAttendue = lignesAttendues[i] || "";

        if (!ligneSaisie || !ligneAttendue) { lignesRatees++; continue; }
        if (ligneSaisie === ligneAttendue) continue;

        let lignePenalites = 0;
        const motsSaisis = ligneSaisie.split(/\s+/);
        const motsAttendus = ligneAttendue.split(/\s+/);

        for (let j = 0; j < Math.max(motsSaisis.length, motsAttendus.length); j++) {
          const motSaisi = motsSaisis[j] || "";
          const motAttendu = motsAttendus[j] || "";
          if (motSaisi !== motAttendu) {
            lignePenalites++;
            const len = Math.min(motSaisi.length, motAttendu.length);
            for (let k = 0; k < len; k++) if (motSaisi[k] !== motAttendu[k]) lignePenalites++;
            lignePenalites += Math.abs(motSaisi.length - motAttendu.length);
          }
        }

        penalites += Math.min(5, lignePenalites);
      }

      if (lignesRatees === 1) penalites += 5;
      else if (lignesRatees >= 2) penalites += 10;

      return penalites;
    }

    async function terminer() {
      const nom = document.getElementById("nom").value.trim() || "Anonyme";
      const texteSaisi = document.getElementById("zone-saisie").value;
      const tempsUtilise = Math.round((Date.now() - debut) / 1000);
      const totalFrappe = texteSaisi.length;

      const penalites = calculerPenalitesAvancees(texteSaisi, TEXTE_ATTENDU);
      const pourcentage = totalFrappe > 0 ? ((penalites / totalFrappe) * 100).toFixed(2) : 0;

      let mention = "Excellent";
      if (pourcentage > 10) mention = "Insuffisant";
      else if (pourcentage > 5) mention = "Moyen";
      else if (pourcentage > 2) mention = "Bien";

      document.getElementById("resultat").innerText =
        `Nom: ${nom}, Frappe: ${totalFrappe}, Pénalités: ${penalites}, Erreurs: ${pourcentage}%, Mention: ${mention}`;

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxXhszJE-OEUe3yAdHpT6JdwyD_qJKc_vC3JnMnmsktvFKMpr3G7g_d8Nk_58oG9rpB/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nom: nom,
            texteTape: texteSaisi,
            penalites: penalites,
            totalFrappe: totalFrappe,
            pourcentage: pourcentage,
            mention: mention,
            tempsUtilise: tempsUtilise
          })
        });

        const data = await response.json();
        if (data.status === "ok") alert("Résultat envoyé avec succès !");
        else alert("Erreur envoi: " + data.message);
      } catch (err) {
        alert("Erreur envoi: " + err);
      }
    }
  </script>

</body>
</html>
